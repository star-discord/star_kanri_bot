# totusuna_csv.js コマンド仕様書

## 概要
今月の凸スナ報告CSVファイルの保存状況を確認するための管理コマンドです。データ管理とファイル確認に使用します。

## コマンド情報
- **コマンド名**: `/凸スナcsv`
- **説明**: 今月の凸スナ報告CSVの保存状況を確認します（管理者専用）
- **権限**: 管理者専用（requireAdmin適用）
- **応答形式**: Ephemeral（プライベートメッセージ）

## 機能詳細

### 主な機能
1. 今月のCSVファイル存在確認
2. ファイル名の表示
3. 保存状況のステータス表示

### ファイル命名規則
```javascript
const now = new Date();
const yyyyMM = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
const fileName = `${guildId}-${yyyyMM}-凸スナ報告.csv`;
```

**例**: `1234567890123-2025-07-凸スナ報告.csv`

### ファイルパス構造
```javascript
const filePath = path.join(__dirname, `../data/${guildId}/${fileName}`);
```

**完全パス例**: `data/1234567890123/1234567890123-2025-07-凸スナ報告.csv`

## 依存関係
- `discord.js`: SlashCommandBuilder, MessageFlags
- `fs`: ファイル存在確認
- `path`: パス操作
- `../utils/embedHelper`: createAdminEmbed
- `../utils/permissions/requireAdmin`: 管理者権限チェック

## 実行フロー
1. 管理者権限チェック
2. 現在の年月取得
3. ファイル名生成
4. ファイル存在確認
5. 結果Embed作成
6. ステータス表示

## 表示内容
```javascript
const embed = createAdminEmbed(
  '🧾 今月の凸スナCSV保存状況',
  `📁 ファイル名：\`${fileName}\`\n\n保存状態：${exists ? '✅ 存在' : '❌ なし'}`
);
```

### 表示例
```
🧾 今月の凸スナCSV保存状況
📁 ファイル名：`1234567890123-2025-07-凸スナ報告.csv`

保存状態：✅ 存在
```

## データ形式
CSVファイルの想定フォーマット：
```csv
日時,グループ,名前,テーブル1,テーブル2,テーブル3,テーブル4,詳細,ユーザー名
2025/07/13 14:30:00,チームA,田中太郎,1,2,3,4,特記事項なし,tanaka_taro
```

## エラーハンドリング
- ファイルアクセスエラー: `fs.existsSync()` の内部処理
- 権限エラー: requireAdminによる自動拒否
- パス関連エラー: path.join()の内部処理

## 使用例
```
/凸スナcsv
→ 「🧾 今月の凸スナCSV保存状況」を表示
→ ファイル名と存在状況を確認
```

## 管理用途
1. **データ確認**: 月次データの存在確認
2. **バックアップ状況**: ファイル保存状況の把握
3. **トラブルシューティング**: データ欠損の早期発見

## 関連機能
- **凸スナ報告機能**: 実際のCSV書き込み処理
- **Excel連携**: `utils/writeTotusunaXlsx.js`との連携
- **GCS同期**: Google Cloud Storageバックアップ

## 今後の拡張予定
- ファイルサイズの表示
- 行数（報告件数）の表示
- 過去月のファイル一覧表示
- ダウンロード機能の提供

## 注意事項
- ファイル存在確認のみで内容検証は未実装
- CSVファイルの破損チェック機能なし
- 大容量ファイル時のパフォーマンス考慮が必要

## トラブルシューティング
1. **ファイルが見つからない**: 凸スナ報告が未実行の可能性
2. **パスエラー**: dataディレクトリの権限確認
3. **日付関連エラー**: システム時刻の確認
