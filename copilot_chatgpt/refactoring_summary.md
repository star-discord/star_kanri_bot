# STAR管理Bot - コード改善・リファクタリングの記録

このドキュメントは、STAR管理Botの安定性と保守性を向上させるために実施された、主要なコード修正と設計改善の概要をまとめたものです。

## 1. Discordインタラクション処理の安定化

プロジェクト全体で最も重要だった改善は、Discordのインタラクションに対する応答処理の安定化です。

### 課題

`DiscordAPIError[40060]: Interaction has already been acknowledged` (既に応答済み) や `DiscordAPIError[10062]: Unknown interaction` (タイムアウト) といったエラーが頻発し、Botの動作が不安定でした。

### 解決方針

Discord APIの仕様を遵守するため、インタラクション応答に関する厳格なルールをプロジェクト全体で適用しました。

- **原則1: 1インタラクションには1応答**
  - `reply()`, `deferReply()`, `showModal()` といった応答メソッドは、1つのインタラクションに対して1度しか呼び出さない。

- **原則2: `deferReply()` と `editReply()` の対での使用**
  - 処理に時間がかかる場合、まず `deferReply()` で応答を保留し、処理完了後に `editReply()` で応答内容を更新する。`deferReply()` の後に `reply()` を呼ぶことは禁止。

- **原則3: `showModal()` の特殊な扱い**
  - `showModal()` はそれ自体が応答として扱われるため、その前後で `deferReply()` や `reply()` は呼び出さない。

- **原則4: 予防的デファー**
  - 3秒以上かかる可能性のある処理（ファイルI/Oや外部API呼び出しなど）では、ハンドラの冒頭で `deferReply()` を呼び出し、タイムアウトを確実に防ぐ。

### 実装例：安全なエラーハンドリング

```javascript
// 修正前（二重応答のリスクがあった）
} catch (error) {
    // この時点で interaction.deferred が true か false か不明なまま応答しようとしていた
    await interaction.reply({ content: 'エラー' });
}

// 修正後（安全なエラーハンドラ）
} catch (error) {
    console.error('コマンド実行エラー:', error);
    // 共通エラーハンドラに処理を委ねる
    await logAndReplyError(
      interaction,
      '❌ [command] コマンド実行中にエラーが発生しました',
      '❌ 処理中にエラーが発生しました'
    );
}
```

## 2. 設計パターンの導入とコード整理

コードの一貫性と再利用性を高めるため、いくつかの設計パターンを導入しました。

### 2.1. 「軽量コマンド」パターンの確立

単にUI（ボタンやEmbed）を表示するだけの高速な処理は「軽量コマンド」と定義し、`deferReply()` を使わずに `interaction.reply()` で即時応答するパターンに統一しました。これにより、コードがシンプルになり、応答性も向上しました。

**代表例: `commands/totusuna_setti.js`**
このコマンドは、管理者向けメニューを表示するだけの軽量な処理のため、`deferReply` を完全に排除し、`reply` で完結させています。

### 2.2. エラーハンドリングの一元化

`utils/errorHelper.js` に `logAndReplyError` 関数を作成し、エラーログの出力とユーザーへの通知処理を共通化しました。この関数内でインタラクションの状態（`deferred`, `replied`）を安全にチェックするため、各コマンドのエラーハンドリングがシンプルかつ堅牢になりました。

### 2.3. 複数ステップ処理の標準化 (`tempStore`)

ボタンクリックからモーダル入力、さらにチャンネル選択へと続く複数ステップの処理において、ステップ間のデータ受け渡しを安全に行うため、`utils/tempStore.js` を導入しました。

**フロー例:**
1.  **モーダル送信時 (`installModal.js`):** ユーザーが入力したデータを `tempStore` に一時保存し、チャンネル選択メニューを表示。
2.  **チャンネル選択時 (`installChannelSelect.js`):** `tempStore` からデータを取得し、目的のチャンネルにメッセージを投稿。
3.  **処理完了後:** `tempStore` から一時データを削除し、多重投稿を防止。

## 3. コード品質と保守性の向上

- **モーダルコンポーネント数の修正**:
  Discord APIの制限（モーダルは最大5コンポーネントまで）を超える数の入力欄を追加しようとしていた問題を修正しました。

- **パフォーマンス改善**:
  `ButtonBuilder` などのUIコンポーネントの定義を `execute` 関数の外に移動させ、コマンドが実行されるたびにインスタンスが再生成されるのを防ぎました。

- **ファイルI/Oの競合回避**:
  `ConfigManager.js` にて、ファイルへの同時書き込みを防ぐための簡易的なロック機構 (`acquireLock`/`releaseLock`) を導入し、設定ファイルのデータ破損リスクを低減しました。

- **コードのDRY原則適用**:
  `createAdminEmbed`, `createSuccessEmbed` などの共通のEmbed生成関数を `utils/embedHelper.js` に集約し、コードの重複を排除しました。

- **堅牢なデプロイスクリプト**:
  `update.sh` や `diagnose.sh` などの運用スクリプトを強化し、エラーハンドリング、リトライ処理、自動バックアップ機能を充実させました。